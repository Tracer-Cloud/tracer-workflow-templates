# Use the data directory from the configuration file
DATA_DIR = "/workspace/tracer-workflow-templates/data"

# Rule for creating a STAR genome index
rule star_index:
    input:
        fasta=f"{DATA_DIR}/human.fa",
        gtf=f"{DATA_DIR}/hg19_anno.gtf"
    output:
        index_dir=directory("human_star")
    threads: 4
    shell:
        """
        STAR --runThreadN {threads} --runMode genomeGenerate \
            --genomeDir {output.index_dir} --genomeSAindexNbases 10 \
            --genomeFastaFiles {input.fasta} --sjdbGTFfile {input.gtf} \
            --sjdbOverhang 99
        """

# Rule for aligning control RNA-Seq reads using STAR
rule star_align_control:
    input:
        index_dir="human_star",
        reads1=f"{DATA_DIR}/control1_1.fq",
        reads2=f"{DATA_DIR}/control1_2.fq"
    output:
        bam="control.sorted.bam"
    threads: 4
    shell:
        """
        STAR --runThreadN {threads} --genomeDir {input.index_dir} \
            --readFilesIn {input.reads1} {input.reads2} \
            --outFileNamePrefix control_star --outSAMtype BAM SortedByCoordinate --quantMode GeneCounts;
        mv control_starAligned.sortedByCoord.out.bam {output.bam}
        """

# Rule for aligning test RNA-Seq reads using STAR
rule star_align_test:
    input:
        index_dir="human_star",
        reads1=f"{DATA_DIR}/test1_1.fq",
        reads2=f"{DATA_DIR}/test1_2.fq"
    output:
        bam="test.sorted.bam"
    threads: 4
    shell:
        """
        STAR --runThreadN {threads} --genomeDir {input.index_dir} \
            --readFilesIn {input.reads1} {input.reads2} \
            --outFileNamePrefix test_star --outSAMtype BAM SortedByCoordinate --quantMode GeneCounts;
        mv test_starAligned.sortedByCoord.out.bam {output.bam}
        """

# Rule for indexing control BAM files with SAMtools
rule samtools_index_control:
    input:
        bam="control.sorted.bam"
    output:
        bai="control.sorted.bam.bai"
    shell:
        """
        samtools index {input.bam}
        """

# Rule for indexing test BAM files with SAMtools
rule samtools_index_test:
    input:
        bam="test.sorted.bam"
    output:
        bai="test.sorted.bam.bai"
    shell:
        """
        samtools index {input.bam}
        """

# Rule for predicting transcripts using StringTie for control
rule stringtie_control:
    input:
        bam="control.sorted.bam",
        gtf=f"{DATA_DIR}/hg19_anno.gtf"
    output:
        gtf="control.gtf"
    shell:
        """
        stringtie -o {output.gtf} -G {input.gtf} {input.bam}
        """

# Rule for calculating transcript counts using featureCounts for control
rule featurecounts_control:
    input:
        bam="control.sorted.bam",
        gtf=f"{DATA_DIR}/hg19_anno.gtf"
    output:
        counts="control_counts.txt"
    threads: 4
    shell:
        """
        featureCounts -p --countReadPairs -B -C -T {threads} -a {input.gtf} -o {output.counts} {input.bam}
        """

# Rule for predicting transcripts using StringTie for test
rule stringtie_test:
    input:
        bam="test.sorted.bam",
        gtf=f"{DATA_DIR}/hg19_anno.gtf"
    output:
        gtf="test.gtf"
    shell:
        """
        stringtie -o {output.gtf} -G {input.gtf} {input.bam}
        """

# Rule for calculating transcript counts using featureCounts for test
rule featurecounts_test:
    input:
        bam="test.sorted.bam",
        gtf=f"{DATA_DIR}/hg19_anno.gtf"
    output:
        counts="test_counts.txt"
    threads: 4
    shell:
        """
        featureCounts -p --countReadPairs -B -C -T {threads} -a {input.gtf} -o {output.counts} {input.bam}
        """

# Rule for collating logs and performing post-mapping QC with MultiQC
rule multiqc:
    input:
        expand("{sample}_counts.txt", sample=["control", "test"]),
        expand("{sample}.gtf", sample=["control", "test"]),
        expand("{sample}.sorted.bam", sample=["control", "test"])
    output:
        report="multiqc_report.html"
    shell:
        """
        multiqc .
        """

# Rule for generating summary of BAM files using deeptools
rule deeptools_summary:
    input:
        bam_control="control.sorted.bam",
        bam_test="test.sorted.bam"
    output:
        npz="rnaseq.npz"
    shell:
        """
        multiBamSummary bins --bamfiles {input.bam_control} {input.bam_test} -o {output.npz}
        """

# Rule for PCA analysis using deeptools
rule pca_plot:
    input:
        npz="rnaseq.npz"
    output:
        pca_png="PCA_rnaseq.png"
    shell:
        """
        plotPCA -in {input.npz} -o {output.pca_png}
        """

# Rule for RNA-Seq data comparison via Fingerprint plots using deeptools
rule fingerprint_plot:
    input:
        bam_control="control.sorted.bam",
        bam_test="test.sorted.bam"
    output:
        fingerprint_png="fingerprint_rnaseq.png"
    shell:
        """
        plotFingerprint -b {input.bam_control} {input.bam_test} --labels Control Test --plotFile {output.fingerprint_png}
        """

# Rule for obtaining bigwig files for visualization using deeptools
rule bamcompare:
    input:
        bam_control="control.sorted.bam",
        bam_test="test.sorted.bam"
    output:
        bw="differential.bw"
    shell:
        """
        bamCompare -b1 {input.bam_test} -b2 {input.bam_control} -o {output.bw} -of bigwig
        """

# Rule for running the R script for edgeR analysis and heatmap creation
rule run_deseq2_r:
    input:
        counts_control="control_counts.txt",
        counts_test="test_counts.txt",
        diff_txt=f"{DATA_DIR}/diff.txt"  # Assuming diff.txt is in the data directory
    output:
        csv="edger_results.csv",
        heatmap_png="diff_heatmap.png"
    shell:
        """
        Rscript ./DESeq2.r
        """

# Final target rule that depends on the final outputs you want
rule all:
    input:
        "control.sorted.bam.bai",
        "test.sorted.bam.bai",
        "control_counts.txt",
        "test_counts.txt",
        "control.gtf",
        "test.gtf",
        "multiqc_report.html",
        "rnaseq.npz",
        "PCA_rnaseq.png",
        "fingerprint_rnaseq.png",
        "differential.bw",
        "edger_results.csv",
        "diff_heatmap.png"